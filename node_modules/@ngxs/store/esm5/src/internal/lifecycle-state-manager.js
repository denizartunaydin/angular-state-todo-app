/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NgxsBootstrapper } from '@ngxs/store/internals';
import { filter, mergeMap, tap } from 'rxjs/operators';
import { StateContextFactory } from './state-context-factory';
import { InternalStateOperations } from './state-operations';
import { getStateDiffChanges } from './internals';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@ngxs/store/internals';
var LifecycleStateManager = /** @class */ (function () {
    function LifecycleStateManager(internalStateOperations, stateContextFactory, bootstrapper) {
        this.internalStateOperations = internalStateOperations;
        this.stateContextFactory = stateContextFactory;
        this.bootstrapper = bootstrapper;
    }
    /**
     * @template T
     * @param {?} action
     * @param {?} results
     * @return {?}
     */
    LifecycleStateManager.prototype.ngxsBootstrap = /**
     * @template T
     * @param {?} action
     * @param {?} results
     * @return {?}
     */
    function (action, results) {
        var _this = this;
        this.internalStateOperations
            .getRootStateOperations()
            .dispatch(action)
            .pipe(filter((/**
         * @return {?}
         */
        function () { return !!results; })), tap((/**
         * @return {?}
         */
        function () { return _this.invokeInit((/** @type {?} */ (results)).states); })), mergeMap((/**
         * @return {?}
         */
        function () { return _this.bootstrapper.appBootstrapped$; })), filter((/**
         * @param {?} appBootstrapped
         * @return {?}
         */
        function (appBootstrapped) { return !!appBootstrapped; })))
            .subscribe((/**
         * @return {?}
         */
        function () { return _this.invokeBootstrap((/** @type {?} */ (results)).states); }));
    };
    /**
     * Invoke the init function on the states.
     */
    /**
     * Invoke the init function on the states.
     * @param {?} mappedStores
     * @return {?}
     */
    LifecycleStateManager.prototype.invokeInit = /**
     * Invoke the init function on the states.
     * @param {?} mappedStores
     * @return {?}
     */
    function (mappedStores) {
        var e_1, _a;
        try {
            for (var mappedStores_1 = tslib_1.__values(mappedStores), mappedStores_1_1 = mappedStores_1.next(); !mappedStores_1_1.done; mappedStores_1_1 = mappedStores_1.next()) {
                var mappedStore = mappedStores_1_1.value;
                /** @type {?} */
                var instance = mappedStore.instance;
                if (instance.ngxsOnChanges) {
                    /** @type {?} */
                    var currentAppState = {};
                    /** @type {?} */
                    var newAppState = this.internalStateOperations
                        .getRootStateOperations()
                        .getState();
                    /** @type {?} */
                    var firstDiffChange = getStateDiffChanges(mappedStore, {
                        currentAppState: currentAppState,
                        newAppState: newAppState
                    });
                    instance.ngxsOnChanges(firstDiffChange);
                }
                if (instance.ngxsOnInit) {
                    instance.ngxsOnInit(this.getStateContext(mappedStore));
                }
                mappedStore.isInitialised = true;
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (mappedStores_1_1 && !mappedStores_1_1.done && (_a = mappedStores_1.return)) _a.call(mappedStores_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    /**
     * Invoke the bootstrap function on the states.
     */
    /**
     * Invoke the bootstrap function on the states.
     * @param {?} mappedStores
     * @return {?}
     */
    LifecycleStateManager.prototype.invokeBootstrap = /**
     * Invoke the bootstrap function on the states.
     * @param {?} mappedStores
     * @return {?}
     */
    function (mappedStores) {
        var e_2, _a;
        try {
            for (var mappedStores_2 = tslib_1.__values(mappedStores), mappedStores_2_1 = mappedStores_2.next(); !mappedStores_2_1.done; mappedStores_2_1 = mappedStores_2.next()) {
                var mappedStore = mappedStores_2_1.value;
                /** @type {?} */
                var instance = mappedStore.instance;
                if (instance.ngxsAfterBootstrap) {
                    instance.ngxsAfterBootstrap(this.getStateContext(mappedStore));
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (mappedStores_2_1 && !mappedStores_2_1.done && (_a = mappedStores_2.return)) _a.call(mappedStores_2);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    /**
     * @private
     * @param {?} mappedStore
     * @return {?}
     */
    LifecycleStateManager.prototype.getStateContext = /**
     * @private
     * @param {?} mappedStore
     * @return {?}
     */
    function (mappedStore) {
        return this.stateContextFactory.createStateContext(mappedStore);
    };
    /** @nocollapse */
    LifecycleStateManager.ctorParameters = function () { return [
        { type: InternalStateOperations },
        { type: StateContextFactory },
        { type: NgxsBootstrapper }
    ]; };
LifecycleStateManager.ɵfac = function LifecycleStateManager_Factory(t) { return new (t || LifecycleStateManager)(ɵngcc0.ɵɵinject(InternalStateOperations), ɵngcc0.ɵɵinject(StateContextFactory), ɵngcc0.ɵɵinject(ɵngcc1.NgxsBootstrapper)); };
LifecycleStateManager.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: LifecycleStateManager, factory: function (t) { return LifecycleStateManager.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(LifecycleStateManager, [{
        type: Injectable
    }], function () { return [{ type: InternalStateOperations }, { type: StateContextFactory }, { type: ɵngcc1.NgxsBootstrapper }]; }, null); })();
    return LifecycleStateManager;
}());
export { LifecycleStateManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LifecycleStateManager.prototype.internalStateOperations;
    /**
     * @type {?}
     * @private
     */
    LifecycleStateManager.prototype.stateContextFactory;
    /**
     * @type {?}
     * @private
     */
    LifecycleStateManager.prototype.bootstrapper;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlmZWN5Y2xlLXN0YXRlLW1hbmFnZXIuanMiLCJzb3VyY2VzIjpbIm5nOi9Abmd4cy9zdG9yZS9zcmMvaW50ZXJuYWwvbGlmZWN5Y2xlLXN0YXRlLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBZSxNQUFNLHVCQUF1QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzdELE9BQU8sRUFBRSxtQkFBbUIsRUFBa0MsTUFBTSxhQUFhLENBQUM7OztBQUdsRjtBQUVNLElBQUosK0JBQ1UsdUJBQWdELEVBQ2hELG1CQUF3QyxFQUN4QyxZQUE4QjtBQUN2QyxRQUhTLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7QUFBQyxRQUNqRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0FBQUMsUUFDekMsaUJBQVksR0FBWixZQUFZLENBQWtCO0FBQzFDLElBQUssQ0FBQztBQUNOO0FBQ087QUFBbUI7QUFBeUI7QUFBMEI7QUFDM0Q7QUFBUSxJQUR4Qiw2Q0FBYTtBQUFPO0FBQW1CO0FBQXlCO0FBQ3BEO0FBQ2Q7QUFBUSxJQUZOLFVBQWlCLE1BQVMsRUFBRSxPQUFzQztBQUFJLFFBQXRFLGlCQVdDO0FBQ0gsUUFYSSxJQUFJLENBQUMsdUJBQXVCO0FBQ2hDLGFBQU8sc0JBQXNCLEVBQUU7QUFDL0IsYUFBTyxRQUFRLENBQUMsTUFBTSxDQUFDO0FBQ3ZCLGFBQU8sSUFBSSxDQUNILE1BQU07QUFBTTtBQUNWO0FBQVksUUFEUCxjQUFNLE9BQUEsQ0FBQyxDQUFDLE9BQU8sRUFBVCxDQUFTLEVB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LEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBRUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUVBLEFBRUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBaEVBLEFBQUEsQUFKQSxBQUFBLEFBREEsQUFBQSxBQUhBLEFBQUEsQUF5RUEsQUFBQSxBQUFBLEFBakVBLEFBaUVBLEFBaEVBLEFBQUEsQUFFQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5neHNCb290c3RyYXBwZXIsIFBsYWluT2JqZWN0IH0gZnJvbSAnQG5neHMvc3RvcmUvaW50ZXJuYWxzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBtZXJnZU1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgU3RhdGVDb250ZXh0RmFjdG9yeSB9IGZyb20gJy4vc3RhdGUtY29udGV4dC1mYWN0b3J5JztcclxuaW1wb3J0IHsgSW50ZXJuYWxTdGF0ZU9wZXJhdGlvbnMgfSBmcm9tICcuL3N0YXRlLW9wZXJhdGlvbnMnO1xyXG5pbXBvcnQgeyBnZXRTdGF0ZURpZmZDaGFuZ2VzLCBNYXBwZWRTdG9yZSwgU3RhdGVzQW5kRGVmYXVsdHMgfSBmcm9tICcuL2ludGVybmFscyc7XHJcbmltcG9ydCB7IE5neHNMaWZlQ3ljbGUsIE5neHNTaW1wbGVDaGFuZ2UsIFN0YXRlQ29udGV4dCB9IGZyb20gJy4uL3N5bWJvbHMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTGlmZWN5Y2xlU3RhdGVNYW5hZ2VyIHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW50ZXJuYWxTdGF0ZU9wZXJhdGlvbnM6IEludGVybmFsU3RhdGVPcGVyYXRpb25zLFxyXG4gICAgcHJpdmF0ZSBzdGF0ZUNvbnRleHRGYWN0b3J5OiBTdGF0ZUNvbnRleHRGYWN0b3J5LFxyXG4gICAgcHJpdmF0ZSBib290c3RyYXBwZXI6IE5neHNCb290c3RyYXBwZXJcclxuICApIHt9XHJcblxyXG4gIG5neHNCb290c3RyYXA8VD4oYWN0aW9uOiBULCByZXN1bHRzOiBTdGF0ZXNBbmREZWZhdWx0cyB8IHVuZGVmaW5lZCk6IHZvaWQge1xyXG4gICAgdGhpcy5pbnRlcm5hbFN0YXRlT3BlcmF0aW9uc1xyXG4gICAgICAuZ2V0Um9vdFN0YXRlT3BlcmF0aW9ucygpXHJcbiAgICAgIC5kaXNwYXRjaChhY3Rpb24pXHJcbiAgICAgIC5waXBlKFxyXG4gICAgICAgIGZpbHRlcigoKSA9PiAhIXJlc3VsdHMpLFxyXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmludm9rZUluaXQocmVzdWx0cyEuc3RhdGVzKSksXHJcbiAgICAgICAgbWVyZ2VNYXAoKCkgPT4gdGhpcy5ib290c3RyYXBwZXIuYXBwQm9vdHN0cmFwcGVkJCksXHJcbiAgICAgICAgZmlsdGVyKGFwcEJvb3RzdHJhcHBlZCA9PiAhIWFwcEJvb3RzdHJhcHBlZClcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMuaW52b2tlQm9vdHN0cmFwKHJlc3VsdHMhLnN0YXRlcykpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW52b2tlIHRoZSBpbml0IGZ1bmN0aW9uIG9uIHRoZSBzdGF0ZXMuXHJcbiAgICovXHJcbiAgaW52b2tlSW5pdChtYXBwZWRTdG9yZXM6IE1hcHBlZFN0b3JlW10pOiB2b2lkIHtcclxuICAgIGZvciAoY29uc3QgbWFwcGVkU3RvcmUgb2YgbWFwcGVkU3RvcmVzKSB7XHJcbiAgICAgIGNvbnN0IGluc3RhbmNlOiBOZ3hzTGlmZUN5Y2xlID0gbWFwcGVkU3RvcmUuaW5zdGFuY2U7XHJcblxyXG4gICAgICBpZiAoaW5zdGFuY2Uubmd4c09uQ2hhbmdlcykge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRBcHBTdGF0ZTogUGxhaW5PYmplY3QgPSB7fTtcclxuICAgICAgICBjb25zdCBuZXdBcHBTdGF0ZTogUGxhaW5PYmplY3QgPSB0aGlzLmludGVybmFsU3RhdGVPcGVyYXRpb25zXHJcbiAgICAgICAgICAuZ2V0Um9vdFN0YXRlT3BlcmF0aW9ucygpXHJcbiAgICAgICAgICAuZ2V0U3RhdGUoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZmlyc3REaWZmQ2hhbmdlOiBOZ3hzU2ltcGxlQ2hhbmdlID0gZ2V0U3RhdGVEaWZmQ2hhbmdlcyhtYXBwZWRTdG9yZSwge1xyXG4gICAgICAgICAgY3VycmVudEFwcFN0YXRlLFxyXG4gICAgICAgICAgbmV3QXBwU3RhdGVcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaW5zdGFuY2Uubmd4c09uQ2hhbmdlcyhmaXJzdERpZmZDaGFuZ2UpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoaW5zdGFuY2Uubmd4c09uSW5pdCkge1xyXG4gICAgICAgIGluc3RhbmNlLm5neHNPbkluaXQodGhpcy5nZXRTdGF0ZUNvbnRleHQobWFwcGVkU3RvcmUpKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgbWFwcGVkU3RvcmUuaXNJbml0aWFsaXNlZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbnZva2UgdGhlIGJvb3RzdHJhcCBmdW5jdGlvbiBvbiB0aGUgc3RhdGVzLlxyXG4gICAqL1xyXG4gIGludm9rZUJvb3RzdHJhcChtYXBwZWRTdG9yZXM6IE1hcHBlZFN0b3JlW10pIHtcclxuICAgIGZvciAoY29uc3QgbWFwcGVkU3RvcmUgb2YgbWFwcGVkU3RvcmVzKSB7XHJcbiAgICAgIGNvbnN0IGluc3RhbmNlOiBOZ3hzTGlmZUN5Y2xlID0gbWFwcGVkU3RvcmUuaW5zdGFuY2U7XHJcbiAgICAgIGlmIChpbnN0YW5jZS5uZ3hzQWZ0ZXJCb290c3RyYXApIHtcclxuICAgICAgICBpbnN0YW5jZS5uZ3hzQWZ0ZXJCb290c3RyYXAodGhpcy5nZXRTdGF0ZUNvbnRleHQobWFwcGVkU3RvcmUpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRTdGF0ZUNvbnRleHQobWFwcGVkU3RvcmU6IE1hcHBlZFN0b3JlKTogU3RhdGVDb250ZXh0PGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhdGVDb250ZXh0RmFjdG9yeS5jcmVhdGVTdGF0ZUNvbnRleHQobWFwcGVkU3RvcmUpO1xyXG4gIH1cclxufVxyXG4iXX0=